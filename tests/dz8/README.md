# Тестирование саги процесса оформления заказа (ДЗ №8)

Данный документ содержит инструкции по тестированию саги процесса обработки заказа в микросервисной архитектуре, реализованной в рамках ДЗ №8.

## Процесс работы саги

Сага процесса обработки заказа инициируется и координируется Сервисом заказов (Order Service) с использованием паттерна "Оркестрация". Она обеспечивает согласованность данных между несколькими микросервисами при создании заказа.

**Последовательность шагов саги:**

1.  **`create_order`** (Order Service): Сервис заказов создает заказ в статусе `PENDING` и инициирует состояние саги.
2.  **`process_billing`** (Billing Service): Оркестратор отправляет команду для проверки баланса и/или резервирования средств на счету пользователя.
3.  **`process_payment`** (Payment Service): После успешного биллинга оркестратор отправляет команду для фактической обработки платежа.
4.  **`reserve_warehouse`** (Warehouse Service): После успешной оплаты оркестратор отправляет команду для проверки наличия и резервирования товаров на складе.
5.  **`reserve_delivery`** (Delivery Service): После успешного резервирования товаров оркестратор отправляет команду для планирования и резервирования доставки.
6.  **`confirm_order`** (Order Service): Если все предыдущие шаги успешно выполнены, оркестратор выполняет внутренний шаг подтверждения заказа, меняя его статус (например, на `CONFIRMED` или `PROCESSING`).
7.  **`notify_customer`** (Notification Service): После подтверждения заказа оркестратор отправляет команду для уведомления клиента об успешном оформлении.

**Механизм компенсации:**

Если на любом из компенсируемых шагов (`process_billing`, `process_payment`, `reserve_warehouse`, `reserve_delivery`) происходит сбой (сервис возвращает результат `failure`), Сервис заказов (оркестратор) запускает процесс компенсации. Компенсирующие команды (`saga.<step_name>.compensate`) отправляются в обратном порядке для **успешно выполненных** шагов, чтобы отменить их действия (например, отменить резерв на складе, вернуть платеж, отменить резерв средств в биллинге). Если компенсация проходит успешно, статус заказа меняется на `FAILED` или `CANCELLED`. Если компенсация какого-либо шага не удается, сага переходит в состояние `COMPENSATION_FAILED`, требующее ручного вмешательства.

## Подготовка тестового окружения

1.  Убедитесь, что все необходимые микросервисы запущены:
    *   `order-service` (порт 8080, координатор саги)
    *   `billing-service` (порт 8081)
    *   `notification-service` (порт 8082) 
    *   `payment-service` (порт 8083)
    *   `warehouse-service` (порт 8084)
    *   `delivery-service` (порт 8085)
    *   Зависимости (PostgreSQL для каждого сервиса, RabbitMQ)

2.  Применение миграций и подготовка тестовых данных:
    *   Воспользуйтесь скриптом для создания баз данных и применения миграций:
        ```bash
        cd src/tests/dz8
        chmod +x apply_test_migrations.sh
        ./apply_test_migrations.sh
        ```

## Тестирование с помощью Postman

1.  Импорт коллекции Postman:
    *   Откройте Postman.
    *   Импортируйте файл коллекции, предназначенный для тестирования саги: `src/tests/dz8/saga_test_collection.json`.

2.  Выполните запросы для проверки различных сценариев:

    Коллекция `saga_test_collection.json` позволяет протестировать следующие основные аспекты:
    *   **Подготовка:** Включает запросы для регистрации нового пользователя, его авторизации, проверки доступности слотов доставки и пополнения баланса перед созданием заказа.
    *   **Успешное выполнение саги:** Содержит запросы для создания заказа, который должен успешно пройти все этапы саги (биллинг, оплата, склад, доставка), а также запросы для последующей проверки статуса самого заказа и связанных с ним сущностей (доставки, платежа, резерва на складе).
    *   **Компенсация при сбое (недостаточно средств):** Включает сценарий создания заказа с заведомо недостаточным балансом для инициации и проверки работы компенсирующих транзакций. Также содержит запрос для проверки итогового статуса такого заказа (ожидается `failed` или `cancelled`).


3.  Для каждого тестового случая анализируйте:
    *   Логи `order-service` (оркестратора) для отслеживания состояний саги.
    *   Логи участвующих сервисов для подтверждения получения команд (`execute`, `compensate`) и отправки результатов (`result`).
    *   Состояние записи саги в таблице `saga_states` базы данных `orders`.
    *   Финальный статус заказа в таблице `orders`.

## Мониторинг событий саги

Вы можете отслеживать события саги через RabbitMQ:
1. Доступ к интерфейсу управления RabbitMQ: http://localhost:15672 (логин: guest, пароль: guest)
2. Проверьте очереди и обмены, связанные с сагой обработки заказа
3. Отслеживайте поток сообщений между сервисом заказов и другими сервисами во время выполнения саги

## Устранение неполадок

- Если какой-либо сервис не может обработать команду саги, проверьте его логи на наличие подробностей об ошибке
- Проверьте логи сервиса заказов (order-service), который координирует всю сагу
- Убедитесь, что все сервисы запущены перед тестированием
- Убедитесь, что тестовые данные были правильно загружены скриптом миграции 
- При возникновении проблем с миграциями баз данных, их можно запустить вручную:
  ```bash
  # Пример для сервиса заказов
  migrate -path ../../migrations/order_service -database "postgres://postgres:postgres@localhost:5432/orders?sslmode=disable" up
  ``` 